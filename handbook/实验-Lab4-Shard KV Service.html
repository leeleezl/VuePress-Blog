<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Shard KV Service | lizzzz</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="个人学习笔记">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.b5cedb56.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.19c88e4d.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/7.1224f65b.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.3025eebf.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/1.2cb690fe.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/46.a6385bcd.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.dfb0299a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.479e3941.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.6c5122b0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.300912eb.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.35493753.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.0a7404ee.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.ea1a9e80.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.e7496b3f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.75e38529.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.6040652a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.68139099.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.397511f6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.1c155833.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.da366b76.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.62212fb5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.1417e115.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.8f61babf.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.47176a81.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.c3f44830.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.693811dd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.aa1f8d83.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.67c6bce2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.7dc5c153.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.380ce34c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.b5fcd8bd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.34421d06.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.974c194a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.f5d648dc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.a2eb7d29.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.1b3561cf.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.5db5b2d7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.99a2f9a3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.c61e335a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.9833b957.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.6a051d57.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.3d6b1dc3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.f8480ef0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.73f77983.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.35de75a7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.1d3a80e5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/vendors~docsearch.c040f9c6.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.b5cedb56.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>lizzzz</h3> <p class="description" data-v-59e6cb88>个人学习笔记</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">lizzzz</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      栗子
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/leeleezl" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>9</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      栗子
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/leeleezl" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/vuepress-blog/" class="sidebar-heading clickable router-link-active"><span>欢迎学习</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/" aria-current="page" class="sidebar-link">你好~</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vuepress-blog/handbook/实验-Lab1-MapReduce" class="sidebar-heading clickable open"><span>Mit-6.824 Lab</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-blog/handbook/实验-Lab1-MapReduce.html" class="sidebar-link">实验 1 MapReduce</a></li><li><a href="/vuepress-blog/handbook/实验- Lab2A-Raft 领导人选举.html" class="sidebar-link">实验 2A Raft 选举</a></li><li><a href="/vuepress-blog/handbook/实验-Lab2B-Raft 日志复制.html" class="sidebar-link">实验 2B Raft 日志复制</a></li><li><a href="/vuepress-blog/handbook/实验-Lab2C-Raft 持久化.html" class="sidebar-link">实验 2C Raft 持久化</a></li><li><a href="/vuepress-blog/handbook/实验-Lab2D-Raft 日志压缩.html" class="sidebar-link">实验 2D Raft 日志压缩</a></li><li><a href="/vuepress-blog/handbook/实验-Lab3A-无快照的 KV Service.html" class="sidebar-link">实验 3 KV Service</a></li><li><a href="/vuepress-blog/handbook/实验-Lab4-Shard KV Service.html" class="active sidebar-link">实验 4 Shard KV Service</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Shard KV Service</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Shard KV Service</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>栗子</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023/11/10</span></i> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="shardctler"><a href="#shardctler" class="header-anchor">#</a> ShardCtler</h2> <p>shardCtler 是一个分片控制器，<strong>利用raft进行配置的统一</strong>，下面是 ShardCtler 的总体架构：</p> <img src="https://cdn.jsdelivr.net/gh/leeleezl/blog-image/image-20231130105458204.png" alt="image-20231130105458204" style="zoom:50%;"> <h3 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h3> <p>客户端的主要作用就是发送请求给服务端，其中请求中包含的操作有 Query/Join/Move/Leave，即查询当前配置信息，加入新的 group，移动分片和删除 group，我们将这四类请求都使用一个 RPC Request 进行封装，这样可以简化程序</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> CommandRequest <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Servers   <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// for Join</span>
	GIDs      <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>            <span class="token comment">// for Leave</span>
	Shard     <span class="token builtin">int</span>              <span class="token comment">// for Move</span>
	GID       <span class="token builtin">int</span>              <span class="token comment">// for Move</span>
	Num       <span class="token builtin">int</span>              <span class="token comment">// for Query</span>
	Op        OperationOp
	ClientId  <span class="token builtin">int64</span>
	CommandId <span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CommandResponse <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Err    Err
	Config Config
<span class="token punctuation">}</span>
</code></pre></div><p>此外，同 Lab3 一样，我们依然使用一个（clientId，commandId）唯一确定一个客户端，shardCtler 客户端的实现和 Lab3 客户端的实现大同小异，将 Lab3 中的 get/put 换成 Query/Join/Move/Leave 即可.而且shardCtler 中并没有快照的逻辑</p> <h3 id="状态机"><a href="#状态机" class="header-anchor">#</a> 状态机</h3> <p>状态机中维护了 MemoryConfigStateMachine ，包含了配置相关的数据，客户端的操作最终都会落在状态机上，此外，状态机中要有处理 Join/Leave/Query/Move 的逻辑。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> MemoryConfigStateMachine <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Configs <span class="token punctuation">[</span><span class="token punctuation">]</span>Config
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Num    <span class="token builtin">int</span>              <span class="token comment">// config number</span>
	Shards <span class="token punctuation">[</span>NShards<span class="token punctuation">]</span><span class="token builtin">int</span>     <span class="token comment">// shard -&gt; gid</span>
	Groups <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token comment">// gid -&gt; servers[]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Join 的处理逻辑</strong>：将新的 gid --&gt; servers[]，加入到新的 Config 中对于，新加入的 group 为了保证负载均衡，需要将 shard 分配地更为均匀且尽量产生较少的迁移任务。对于 Join，可以通过多次平均地方式来达到这个目的：每次选择一个拥有 shard 数最多的 raft 组和一个拥有 shard 数最少的 raft 组，将前者管理的一个 shard 分给后者，周而复始，直到它们之前的差值小于等于 1 且 0 raft 组无 shard 为止。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>cf <span class="token operator">*</span>MemoryConfigStateMachine<span class="token punctuation">)</span> <span class="token function">Join</span><span class="token punctuation">(</span>groups <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> Err <span class="token punctuation">{</span>
	<span class="token comment">//取到上一个的config</span>
	lastConfig <span class="token operator">:=</span> cf<span class="token punctuation">.</span>Configs<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	newConfig <span class="token operator">:=</span> Config<span class="token punctuation">{</span><span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span><span class="token punctuation">,</span> lastConfig<span class="token punctuation">.</span>Shards<span class="token punctuation">,</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span>lastConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> gid<span class="token punctuation">,</span> servers <span class="token operator">:=</span> <span class="token keyword">range</span> groups <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> newConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span>gid<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			<span class="token comment">//加入</span>
			newServers <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">copy</span><span class="token punctuation">(</span>newServers<span class="token punctuation">,</span> servers<span class="token punctuation">)</span>
			newConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span>gid<span class="token punctuation">]</span> <span class="token operator">=</span> newServers
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//得到 shard-&gt;group的映射</span>
	s2g <span class="token operator">:=</span> <span class="token function">Group2Shards</span><span class="token punctuation">(</span>newConfig<span class="token punctuation">)</span>
	<span class="token comment">//循环 知道最大分片数量的group 和最小分片数量的group的分片数相差 &lt;=1</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">//找到分片最多和分片最少得 group</span>
		source<span class="token punctuation">,</span> target <span class="token operator">:=</span> <span class="token function">GetGIDWithMaximumShards</span><span class="token punctuation">(</span>s2g<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetGIDWithMinimumShards</span><span class="token punctuation">(</span>s2g<span class="token punctuation">)</span>
		<span class="token keyword">if</span> source <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>s2g<span class="token punctuation">[</span>source<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">len</span><span class="token punctuation">(</span>s2g<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		s2g<span class="token punctuation">[</span>target<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s2g<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">,</span> s2g<span class="token punctuation">[</span>source<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		s2g<span class="token punctuation">[</span>source<span class="token punctuation">]</span> <span class="token operator">=</span> s2g<span class="token punctuation">[</span>source<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 拿到分片调整后的新分片</span>
	<span class="token keyword">var</span> newShards <span class="token punctuation">[</span>NShards<span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token keyword">for</span> gid<span class="token punctuation">,</span> shards <span class="token operator">:=</span> <span class="token keyword">range</span> s2g <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> shard <span class="token operator">:=</span> <span class="token keyword">range</span> shards <span class="token punctuation">{</span>
			newShards<span class="token punctuation">[</span>shard<span class="token punctuation">]</span> <span class="token operator">=</span> gid
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//将新的分片更新到新config中</span>
	newConfig<span class="token punctuation">.</span>Shards <span class="token operator">=</span> newShards
	cf<span class="token punctuation">.</span>Configs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">,</span> newConfig<span class="token punctuation">)</span>
	<span class="token keyword">return</span> OK
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Leave 的处理逻辑</strong>：有 raft 组离开后，我们需要对离开的 raft 组的 shard 进行分配，如果 Leave 后集群中无 raft 组，则将分片所属 raft 组都置为无效的 0；否则将删除 raft 组的分片均匀地分配给仍然存在的 raft 组。通过这样的分配，可以将 shard 分配地十分均匀且产生了几乎最少的迁移任务。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>cf <span class="token operator">*</span>MemoryConfigStateMachine<span class="token punctuation">)</span> <span class="token function">Leave</span><span class="token punctuation">(</span>gids <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> Err <span class="token punctuation">{</span>
	lastConfig <span class="token operator">:=</span> cf<span class="token punctuation">.</span>Configs<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	newConfig <span class="token operator">:=</span> Config<span class="token punctuation">{</span><span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span><span class="token punctuation">,</span> lastConfig<span class="token punctuation">.</span>Shards<span class="token punctuation">,</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span>lastConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">)</span><span class="token punctuation">}</span>
	s2g <span class="token operator">:=</span> <span class="token function">Group2Shards</span><span class="token punctuation">(</span>newConfig<span class="token punctuation">)</span>
	orphanShards <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> gid <span class="token operator">:=</span> <span class="token keyword">range</span> gids <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> newConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span>gid<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>newConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">,</span> gid<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> shards<span class="token punctuation">,</span> ok <span class="token operator">:=</span> s2g<span class="token punctuation">[</span>gid<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			orphanShards <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>orphanShards<span class="token punctuation">,</span> shards<span class="token operator">...</span><span class="token punctuation">)</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>s2g<span class="token punctuation">,</span> gid<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> newShards <span class="token punctuation">[</span>NShards<span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token comment">// load balancing is performed only when raft groups exist</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>newConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> shard <span class="token operator">:=</span> <span class="token keyword">range</span> orphanShards <span class="token punctuation">{</span>
			target <span class="token operator">:=</span> <span class="token function">GetGIDWithMinimumShards</span><span class="token punctuation">(</span>s2g<span class="token punctuation">)</span>
			s2g<span class="token punctuation">[</span>target<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s2g<span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">,</span> shard<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span> gid<span class="token punctuation">,</span> shards <span class="token operator">:=</span> <span class="token keyword">range</span> s2g <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> shard <span class="token operator">:=</span> <span class="token keyword">range</span> shards <span class="token punctuation">{</span>
				newShards<span class="token punctuation">[</span>shard<span class="token punctuation">]</span> <span class="token operator">=</span> gid
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	newConfig<span class="token punctuation">.</span>Shards <span class="token operator">=</span> newShards
	cf<span class="token punctuation">.</span>Configs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">,</span> newConfig<span class="token punctuation">)</span>
	<span class="token keyword">return</span> OK
<span class="token punctuation">}</span>
</code></pre></div><p><strong>对于 Query 和 Move</strong>，直接实现就好：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>cf <span class="token operator">*</span>MemoryConfigStateMachine<span class="token punctuation">)</span> <span class="token function">Move</span><span class="token punctuation">(</span>shard<span class="token punctuation">,</span> gid <span class="token builtin">int</span><span class="token punctuation">)</span> Err <span class="token punctuation">{</span>
	lastConfig <span class="token operator">:=</span> cf<span class="token punctuation">.</span>Configs<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	newConfig <span class="token operator">:=</span> Config<span class="token punctuation">{</span><span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span><span class="token punctuation">,</span> lastConfig<span class="token punctuation">.</span>Shards<span class="token punctuation">,</span> <span class="token function">deepCopy</span><span class="token punctuation">(</span>lastConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">)</span><span class="token punctuation">}</span>
	newConfig<span class="token punctuation">.</span>Shards<span class="token punctuation">[</span>shard<span class="token punctuation">]</span> <span class="token operator">=</span> gid
	cf<span class="token punctuation">.</span>Configs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">,</span> newConfig<span class="token punctuation">)</span>
	<span class="token keyword">return</span> OK
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>cf <span class="token operator">*</span>MemoryConfigStateMachine<span class="token punctuation">)</span> <span class="token function">Query</span><span class="token punctuation">(</span>num <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>Config<span class="token punctuation">,</span> Err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> num <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> num <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> cf<span class="token punctuation">.</span>Configs<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>cf<span class="token punctuation">.</span>Configs<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> OK
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> cf<span class="token punctuation">.</span>Configs<span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">,</span> OK
<span class="token punctuation">}</span>
</code></pre></div><h3 id="服务端"><a href="#服务端" class="header-anchor">#</a> 服务端</h3> <p>服务端要做的就是，提供一个 Rpc 接口 <code>Command(request *CommandRequest, response *CommandResponse)</code>，客户端通过 Rpc 将请求发送给服务端，服务端处理请求时，首先会判断请求是否是重复的，如果是重复的会返回上一次的结果，不进行 Raft 集群的日志同步操作，若是新的请求，服务端会将请求发送给 Raft 集群进行日志的同步，随后 Server 立即开启一个 Channel 来监听结果，Leader 提交日之后可以进行 Apply，服务端在启动时，会启动 applier 协程去监听 applyChan，当有 applyMsg 后，Server 会将操作 apply 到状态机，随后通过 index 取到 server 开启的 Channel，将状态机返回的结果发送至这个 Channel，取到结果后返回客户端。</p> <p><code>Command(request *CommandRequest, response *CommandResponse)</code> RPC 接口：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>sc <span class="token operator">*</span>ShardCtrler<span class="token punctuation">)</span> <span class="token function">Command</span><span class="token punctuation">(</span>request <span class="token operator">*</span>CommandRequest<span class="token punctuation">,</span> response <span class="token operator">*</span>CommandResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}'s state is {}, processes CommandRequest %v with CommandResponse %v&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
	<span class="token comment">// return result directly without raft layer's participation if request is duplicated</span>
	sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 如果是重复请求直接返回之前的结果</span>
	<span class="token keyword">if</span> request<span class="token punctuation">.</span>Op <span class="token operator">!=</span> OpQuery <span class="token operator">&amp;&amp;</span> sc<span class="token punctuation">.</span><span class="token function">isDuplicateRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>CommandId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		lastResponse <span class="token operator">:=</span> sc<span class="token punctuation">.</span>lastOperations<span class="token punctuation">[</span>request<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>LastResponse
		response<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> response<span class="token punctuation">.</span>Err <span class="token operator">=</span> lastResponse<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> lastResponse<span class="token punctuation">.</span>Err
		sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// do not hold lock to improve throughput</span>
	<span class="token comment">//这里进入到raft的逻辑，服务端会监听applyChan, raft处理完日志之后会提交操作到applychan</span>
	index<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> sc<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>Command<span class="token punctuation">{</span>request<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>isLeader <span class="token punctuation">{</span>
		response<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ch <span class="token operator">:=</span> sc<span class="token punctuation">.</span><span class="token function">getNotifyChan</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
	sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> result <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		response<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> response<span class="token punctuation">.</span>Err <span class="token operator">=</span> result<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Err
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>ExecuteTimeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
		response<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrTimeout
	<span class="token punctuation">}</span>
	<span class="token comment">// release notifyChan to reduce memory footprint</span>
	<span class="token comment">// why asynchronously? to improve throughput, here is no need to block client request</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		sc<span class="token punctuation">.</span><span class="token function">removeOutdatedNotifyChan</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
		sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>applier()</code>协程：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>sc <span class="token operator">*</span>ShardCtrler<span class="token punctuation">)</span> <span class="token function">applier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> sc<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token comment">// raft 提交了</span>
		<span class="token keyword">case</span> message <span class="token operator">:=</span> <span class="token operator">&lt;-</span>sc<span class="token punctuation">.</span>applyCh<span class="token punctuation">:</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v} tries to apply message %v&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span>
			<span class="token comment">//判断是操作还是快照</span>
			<span class="token keyword">if</span> message<span class="token punctuation">.</span>CommandValid <span class="token punctuation">{</span>
				<span class="token keyword">var</span> response <span class="token operator">*</span>CommandResponse
				<span class="token comment">//将interface{} 转为 CommandRequest</span>
				command <span class="token operator">:=</span> message<span class="token punctuation">.</span>Command<span class="token punctuation">.</span><span class="token punctuation">(</span>Command<span class="token punctuation">)</span>
				sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

				<span class="token keyword">if</span> command<span class="token punctuation">.</span>Op <span class="token operator">!=</span> OpQuery <span class="token operator">&amp;&amp;</span> sc<span class="token punctuation">.</span><span class="token function">isDuplicateRequest</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span> command<span class="token punctuation">.</span>CommandId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v} doesn't apply duplicated message %v to stateMachine because maxAppliedCommandId is %v for client %v&quot;</span><span class="token punctuation">,</span> sc<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> sc<span class="token punctuation">.</span>lastOperations<span class="token punctuation">[</span>command<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">,</span> command<span class="token punctuation">.</span>ClientId<span class="token punctuation">)</span>
					response <span class="token operator">=</span> sc<span class="token punctuation">.</span>lastOperations<span class="token punctuation">[</span>command<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span><span class="token punctuation">.</span>LastResponse
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// 应用到状态机中</span>
					response <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">applyLogToStateMachine</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
					<span class="token keyword">if</span> command<span class="token punctuation">.</span>Op <span class="token operator">!=</span> OpQuery <span class="token punctuation">{</span>
						sc<span class="token punctuation">.</span>lastOperations<span class="token punctuation">[</span>command<span class="token punctuation">.</span>ClientId<span class="token punctuation">]</span> <span class="token operator">=</span> OperationContext<span class="token punctuation">{</span>command<span class="token punctuation">.</span>CommandId<span class="token punctuation">,</span> response<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// only notify related channel for currentTerm's log when node is leader</span>
				<span class="token comment">// 将结果发送到 notifyChan</span>
				<span class="token keyword">if</span> currentTerm<span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> sc<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> isLeader <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span>CommandTerm <span class="token operator">==</span> currentTerm <span class="token punctuation">{</span>
					ch <span class="token operator">:=</span> sc<span class="token punctuation">.</span><span class="token function">getNotifyChan</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>
					ch <span class="token operator">&lt;-</span> response
				<span class="token punctuation">}</span>

				sc<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected Message %v&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="shardkv"><a href="#shardkv" class="header-anchor">#</a> ShardKV</h2> <h3 id="整体架构"><a href="#整体架构" class="header-anchor">#</a> 整体架构</h3> <p><img src="https://cdn.jsdelivr.net/gh/leeleezl/blog-image/image-20231130135924835.png" alt="image-20231130135924835"></p> <h3 id="client"><a href="#client" class="header-anchor">#</a> client</h3> <p>client 发送 Get/Put/Append 请求，客户端会将请求中的 key 通过 key2shard 方法，定位到这个 key 应该存储到哪个 shard 中，并通过 shard 找到管理这个分片的 group，随后通过 gid 找打 leader server 将请求通过 Rpc 发送给服务器。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>ck <span class="token operator">*</span>Clerk<span class="token punctuation">)</span> <span class="token function">Command</span><span class="token punctuation">(</span>request <span class="token operator">*</span>CommandRequest<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	request<span class="token punctuation">.</span>ClientId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>CommandId <span class="token operator">=</span> ck<span class="token punctuation">.</span>clientId<span class="token punctuation">,</span> ck<span class="token punctuation">.</span>commandId
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// 找到这个key对应于哪个分片</span>
		shard <span class="token operator">:=</span> <span class="token function">key2shard</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>Key<span class="token punctuation">)</span>
		<span class="token comment">// 找到分片对应的group</span>
		gid <span class="token operator">:=</span> ck<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Shards<span class="token punctuation">[</span>shard<span class="token punctuation">]</span>
		
		<span class="token keyword">if</span> servers<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span>gid<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">=</span> ck<span class="token punctuation">.</span>leaderIds<span class="token punctuation">[</span>gid<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
				ck<span class="token punctuation">.</span>leaderIds<span class="token punctuation">[</span>gid<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>
			oldLeaderId <span class="token operator">:=</span> ck<span class="token punctuation">.</span>leaderIds<span class="token punctuation">[</span>gid<span class="token punctuation">]</span>
			newLeaderId <span class="token operator">:=</span> oldLeaderId
			<span class="token keyword">for</span> <span class="token punctuation">{</span>
				<span class="token keyword">var</span> response CommandResponse
				ok <span class="token operator">:=</span> ck<span class="token punctuation">.</span><span class="token function">makeEnd</span><span class="token punctuation">(</span>servers<span class="token punctuation">[</span>newLeaderId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;ShardKV.Command&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">&amp;</span>response<span class="token punctuation">)</span>
				<span class="token keyword">if</span> ok <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token operator">||</span> response<span class="token punctuation">.</span>Err <span class="token operator">==</span> ErrNoKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					ck<span class="token punctuation">.</span>commandId<span class="token operator">++</span>
					<span class="token keyword">return</span> response<span class="token punctuation">.</span>Value
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> ok <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>Err <span class="token operator">==</span> ErrWrongGroup <span class="token punctuation">{</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					newLeaderId <span class="token operator">=</span> <span class="token punctuation">(</span>newLeaderId <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token function">len</span><span class="token punctuation">(</span>servers<span class="token punctuation">)</span>
					<span class="token keyword">if</span> newLeaderId <span class="token operator">==</span> oldLeaderId <span class="token punctuation">{</span>
						<span class="token keyword">break</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>
		<span class="token comment">// ask controller for the latest configuration.</span>
		ck<span class="token punctuation">.</span>config <span class="token operator">=</span> ck<span class="token punctuation">.</span>sm<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="服务端-2"><a href="#服务端-2" class="header-anchor">#</a> 服务端</h3> <p>服务端的逻辑相对复杂，服务端不仅要处理来自客户端的对分片的读写请求，还要有负责监测配置更新的协程，负责分片迁移的协程和负责及时清理不再属于本分片的数据的协程。</p> <p>Lab4 有两个 challenge：</p> <ul><li>challenge1 要求及时清理不再属于本分片的数据</li> <li>challenge2 不仅要求分片迁移时不影响未迁移分片的读写服务，还要求不同地分片数据能够独立迁移</li></ul> <p>解决方案：</p> <ul><li>每个 raft 组需要有一个协程去向 shardctler 拉去最新的配置，一旦拉取到最新的配置，就要提交到当前 raft 组中更新配置</li> <li>为了解决两个 challenge 我们需要将分片独立，因此，ShardKV 应该对每个分片额外维护其它的一些状态变量。对分片的状态进行分类：
<ul><li><code>Serving</code>：默认状态，表示这个分片是由这个 raft 组负责管理的，并且可以进行读写操作</li> <li><code>Pulling</code>：表示这个分片是由这个 raft 组负责管理的，但是这个分片的数据当前并不在这个 Raft 组，需要到 <code>lastConfig</code>中负责管理这个分片的 raft 组中去拉去数据</li> <li><code>BePulling</code>：表示当前这个分片不是由这个 raft 进行管理的，但是当前 raft 组在上一个 config 中是负责管理这个分片的</li> <li><code>GCing</code>：表示当前这个分片是由这个 raft 组进行管理的，可以进行正常的读写操作，但需要清理掉上一个配置该分片所属 raft 组的数据</li></ul></li></ul> <p>日志类型：</p> <p>一共有五中日志类型，这样 apply 协程可以根据不同的类型来强转 Data 来实现下一步的操作：</p> <ul><li>Operation：客户端传来的读写操作，Put/Get/Append</li> <li>Configuration：配置更新日志，包含一个配置</li> <li>InsertShard：分片更新日志，至少包含一个分片的数据和配置版本</li> <li>DeleteShard：分片删除日志，至少包含一个分片的 Id 和配置版本</li> <li>EmptyEntry：空日志，Data 为空，使得状态机达到最新</li></ul> <p>以上即为服务端的实现，首先看一下服务端启动的实现：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">StartServer</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">,</span> me <span class="token builtin">int</span><span class="token punctuation">,</span> persister <span class="token operator">*</span>raft<span class="token punctuation">.</span>Persister<span class="token punctuation">,</span> maxRaftState <span class="token builtin">int</span><span class="token punctuation">,</span> gid <span class="token builtin">int</span><span class="token punctuation">,</span> ctrlers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">,</span> makeEnd <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>labrpc<span class="token punctuation">.</span>ClientEnd<span class="token punctuation">)</span> <span class="token operator">*</span>ShardKV <span class="token punctuation">{</span>
	<span class="token comment">// call labgob.Register on structures you want</span>
	<span class="token comment">// Go's RPC library to marshall/unmarshall.</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>Command<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>CommandRequest<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>shardctrler<span class="token punctuation">.</span>Config<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>ShardOperationResponse<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	labgob<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>ShardOperationRequest<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

	applyCh <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> raft<span class="token punctuation">.</span>ApplyMsg<span class="token punctuation">)</span>

	kv <span class="token operator">:=</span> <span class="token operator">&amp;</span>ShardKV<span class="token punctuation">{</span>
		dead<span class="token punctuation">:</span>           <span class="token number">0</span><span class="token punctuation">,</span>
		rf<span class="token punctuation">:</span>             raft<span class="token punctuation">.</span><span class="token function">Make</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> me<span class="token punctuation">,</span> persister<span class="token punctuation">,</span> applyCh<span class="token punctuation">)</span><span class="token punctuation">,</span>
		applyCh<span class="token punctuation">:</span>        applyCh<span class="token punctuation">,</span>
		makeEnd<span class="token punctuation">:</span>        makeEnd<span class="token punctuation">,</span>
		gid<span class="token punctuation">:</span>            gid<span class="token punctuation">,</span>
		sc<span class="token punctuation">:</span>             shardctrler<span class="token punctuation">.</span><span class="token function">MakeClerk</span><span class="token punctuation">(</span>ctrlers<span class="token punctuation">)</span><span class="token punctuation">,</span>
		lastApplied<span class="token punctuation">:</span>    <span class="token number">0</span><span class="token punctuation">,</span>
		maxRaftState<span class="token punctuation">:</span>   maxRaftState<span class="token punctuation">,</span>
		currentConfig<span class="token punctuation">:</span>  shardctrler<span class="token punctuation">.</span><span class="token function">DefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		lastConfig<span class="token punctuation">:</span>     shardctrler<span class="token punctuation">.</span><span class="token function">DefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		stateMachines<span class="token punctuation">:</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token operator">*</span>Shard<span class="token punctuation">)</span><span class="token punctuation">,</span>
		lastOperations<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int64</span><span class="token punctuation">]</span>OperationContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
		notifyChans<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token keyword">chan</span> <span class="token operator">*</span>CommandResponse<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span><span class="token function">restoreSnapshot</span><span class="token punctuation">(</span>persister<span class="token punctuation">.</span><span class="token function">ReadSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// start applier goroutine to apply committed logs to stateMachine</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">applier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// start configuration monitor goroutine to fetch latest configuration</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>configureAction<span class="token punctuation">,</span> ConfigureMonitorTimeout<span class="token punctuation">)</span>
	<span class="token comment">// start migration monitor goroutine to pull related shards</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>migrationAction<span class="token punctuation">,</span> MigrationMonitorTimeout<span class="token punctuation">)</span>
	<span class="token comment">// start gc monitor goroutine to delete useless shards in remote groups</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>gcAction<span class="token punctuation">,</span> GCMonitorTimeout<span class="token punctuation">)</span>
	<span class="token comment">// start entry-in-currentTerm monitor goroutine to advance commitIndex by appending empty entries in current term periodically to avoid live locks</span>
	<span class="token comment">//启动entry-in-currentTerm monitor例程，通过定期在当前term中添加空条目来推进commitIndex，以避免活锁</span>
	<span class="token keyword">go</span> kv<span class="token punctuation">.</span><span class="token function">Monitor</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>checkEntryInCurrentTermAction<span class="token punctuation">,</span> EmptyEntryDetectorTimeout<span class="token punctuation">)</span>

	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} has started&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">)</span>
	<span class="token keyword">return</span> kv
<span class="token punctuation">}</span>

</code></pre></div><p>再看一下appler()，比较清晰：</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>ShardKV<span class="token punctuation">)</span> <span class="token function">applier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> kv<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> message <span class="token operator">:=</span> <span class="token operator">&lt;-</span>kv<span class="token punctuation">.</span>applyCh<span class="token punctuation">:</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} tries to apply message %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> message<span class="token punctuation">)</span>
			<span class="token keyword">if</span> message<span class="token punctuation">.</span>CommandValid <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> message<span class="token punctuation">.</span>CommandIndex <span class="token operator">&lt;=</span> kv<span class="token punctuation">.</span>lastApplied <span class="token punctuation">{</span>
					<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} discards outdated message %v because a newer snapshot which lastApplied is %v has been restored&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> message<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>lastApplied<span class="token punctuation">)</span>
					kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
				kv<span class="token punctuation">.</span>lastApplied <span class="token operator">=</span> message<span class="token punctuation">.</span>CommandIndex

				<span class="token keyword">var</span> response <span class="token operator">*</span>CommandResponse
				command <span class="token operator">:=</span> message<span class="token punctuation">.</span>Command<span class="token punctuation">.</span><span class="token punctuation">(</span>Command<span class="token punctuation">)</span> <span class="token comment">//包括 Op 和 Data</span>
				<span class="token keyword">switch</span> command<span class="token punctuation">.</span>Op <span class="token punctuation">{</span>
				<span class="token keyword">case</span> Operation<span class="token punctuation">:</span>
					operation <span class="token operator">:=</span> command<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token punctuation">(</span>CommandRequest<span class="token punctuation">)</span>
					response <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">applyOperation</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>message<span class="token punctuation">,</span> <span class="token operator">&amp;</span>operation<span class="token punctuation">)</span>
				<span class="token keyword">case</span> Configuration<span class="token punctuation">:</span>
					nextConfig <span class="token operator">:=</span> command<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token punctuation">(</span>shardctrler<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>
					response <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">applyConfiguration</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nextConfig<span class="token punctuation">)</span>
				<span class="token keyword">case</span> InsertShards<span class="token punctuation">:</span>
					shardsInfo <span class="token operator">:=</span> command<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token punctuation">(</span>ShardOperationResponse<span class="token punctuation">)</span>
					response <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">applyInsertShards</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shardsInfo<span class="token punctuation">)</span>
				<span class="token keyword">case</span> DeleteShards<span class="token punctuation">:</span>
					shardsInfo <span class="token operator">:=</span> command<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token punctuation">(</span>ShardOperationRequest<span class="token punctuation">)</span>
					response <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">applyDeleteShards</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shardsInfo<span class="token punctuation">)</span>
				<span class="token keyword">case</span> EmptyEntry<span class="token punctuation">:</span>
					response <span class="token operator">=</span> kv<span class="token punctuation">.</span><span class="token function">applyEmptyEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>

				<span class="token comment">// only notify related channel for currentTerm's log when node is leader</span>
				<span class="token keyword">if</span> currentTerm<span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> isLeader <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span>CommandTerm <span class="token operator">==</span> currentTerm <span class="token punctuation">{</span>
					ch <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">getNotifyChan</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>
					ch <span class="token operator">&lt;-</span> response
				<span class="token punctuation">}</span>

				needSnapshot <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">needSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> needSnapshot <span class="token punctuation">{</span>
					kv<span class="token punctuation">.</span><span class="token function">takeSnapshot</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>CommandIndex<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> message<span class="token punctuation">.</span>SnapshotValid <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">CondInstallSnapshot</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>SnapshotTerm<span class="token punctuation">,</span> message<span class="token punctuation">.</span>SnapshotIndex<span class="token punctuation">,</span> message<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					kv<span class="token punctuation">.</span><span class="token function">restoreSnapshot</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span>
					kv<span class="token punctuation">.</span>lastApplied <span class="token operator">=</span> message<span class="token punctuation">.</span>SnapshotIndex
				<span class="token punctuation">}</span>
				kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected Message %v&quot;</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>配置更新协程的工作流程</strong>：</p> <p>首先服务启动的时候就启动了一个检测配置更新协程<code>go kv.Monitor(kv.configureAction, ConfigureMonitorTimeout)</code>，检测配置更新协程会去遍历 <code>kv.stateMachines</code> 中的每个分片（shard）。对于每个分片，它检查其状态是否为 &quot;Serving&quot;。如果有任何一个分片的状态不是 &quot;Serving&quot;，则不进配置的拉去，待所有分片的状态都为 &quot;Serving&quot; 后进行配置的拉去，如果有新的配置，则立刻进行 Raft 的日志的同步，更新配置。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//配置更新协程</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>ShardKV<span class="token punctuation">)</span> <span class="token function">configureAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	canPerformNextConfig <span class="token operator">:=</span> <span class="token boolean">true</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> shard <span class="token operator">:=</span> <span class="token keyword">range</span> kv<span class="token punctuation">.</span>stateMachines <span class="token punctuation">{</span>
		<span class="token keyword">if</span> shard<span class="token punctuation">.</span>Status <span class="token operator">!=</span> Serving <span class="token punctuation">{</span>
			canPerformNextConfig <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} will not try to fetch latest configuration because shards status are %v when currentConfig is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> kv<span class="token punctuation">.</span><span class="token function">getShardStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	currentConfigNum <span class="token operator">:=</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">.</span>Num
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> canPerformNextConfig <span class="token punctuation">{</span>
		nextConfig <span class="token operator">:=</span> kv<span class="token punctuation">.</span>sc<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span>currentConfigNum <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> nextConfig<span class="token punctuation">.</span>Num <span class="token operator">==</span> currentConfigNum<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} fetches latest configuration %v when currentConfigNum is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> nextConfig<span class="token punctuation">,</span> currentConfigNum<span class="token punctuation">)</span>
			kv<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token function">NewConfigurationCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>nextConfig<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>CommandResponse<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>ShardKV<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>command Command<span class="token punctuation">,</span> response <span class="token operator">*</span>CommandResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// do not hold lock to improve throughput</span>
	<span class="token comment">// when KVServer holds the lock to take snapshot, underlying raft can still commit raft logs</span>
	index<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>isLeader <span class="token punctuation">{</span>
		response<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} processes Command %v with CommandResponse %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> command<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ch <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">getNotifyChan</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> result <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		response<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> response<span class="token punctuation">.</span>Err <span class="token operator">=</span> result<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Err
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>ExecuteTimeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
		response<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrTimeout
	<span class="token punctuation">}</span>
	<span class="token comment">// release notifyChan to reduce memory footprint</span>
	<span class="token comment">// why asynchronously? to improve throughput, here is no need to block client request</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		kv<span class="token punctuation">.</span><span class="token function">removeOutdatedNotifyChan</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>分片迁移协程的工作流程</strong>：</p> <p>分片迁移协程负责定时检测分片的 Pulling 状态，利用 lastConfig 计算出对应 raft 组的 gid 和要拉取的分片，然后并行地去拉取数据，使用了 waitGroup 来保证所有独立地任务完成后才会进行下一次任务</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>ShardKV<span class="token punctuation">)</span> <span class="token function">migrationAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">//获取状态为 pulling 的分片</span>
	gid2shardIDs <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">getShardIDsByStatus</span><span class="token punctuation">(</span>Pulling<span class="token punctuation">)</span>
	<span class="token comment">// 使用了 waitGroup 来保证所有独立地任务完成后才会进行下一次任务</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	<span class="token keyword">for</span> gid<span class="token punctuation">,</span> shardIDs <span class="token operator">:=</span> <span class="token keyword">range</span> gid2shardIDs <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} starts a PullTask to get shards %v from group %v when config is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> shardIDs<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> configNum <span class="token builtin">int</span><span class="token punctuation">,</span> shardIDs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			pullTaskRequest <span class="token operator">:=</span> ShardOperationRequest<span class="token punctuation">{</span>configNum<span class="token punctuation">,</span> shardIDs<span class="token punctuation">}</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> server <span class="token operator">:=</span> <span class="token keyword">range</span> servers <span class="token punctuation">{</span>
				<span class="token keyword">var</span> pullTaskResponse ShardOperationResponse
				srv <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">makeEnd</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
				<span class="token keyword">if</span> srv<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;ShardKV.GetShardsData&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pullTaskRequest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pullTaskResponse<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pullTaskResponse<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">{</span>
					<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} gets a PullTaskResponse %v and tries to commit it when currentConfigNum is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> pullTaskResponse<span class="token punctuation">,</span> configNum<span class="token punctuation">)</span>
					kv<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token function">NewInsertShardsCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pullTaskResponse<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>CommandResponse<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>lastConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span>gid<span class="token punctuation">]</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">.</span>Num<span class="token punctuation">,</span> shardIDs<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>分片清理工作流程</strong>：</p> <p>分片清理协程负责定时检测分片的 GCing 状态，利用 lastConfig 计算出对应 raft 组的 gid 和要拉取的分片，然后并行地去删除分片。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>ShardKV<span class="token punctuation">)</span> <span class="token function">gcAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gid2shardIDs <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">getShardIDsByStatus</span><span class="token punctuation">(</span>GCing<span class="token punctuation">)</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	<span class="token keyword">for</span> gid<span class="token punctuation">,</span> shardIDs <span class="token operator">:=</span> <span class="token keyword">range</span> gid2shardIDs <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} starts a GCTask to delete shards %v in group %v when config is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> shardIDs<span class="token punctuation">,</span> gid<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>servers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> configNum <span class="token builtin">int</span><span class="token punctuation">,</span> shardIDs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			gcTaskRequest <span class="token operator">:=</span> ShardOperationRequest<span class="token punctuation">{</span>configNum<span class="token punctuation">,</span> shardIDs<span class="token punctuation">}</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> server <span class="token operator">:=</span> <span class="token keyword">range</span> servers <span class="token punctuation">{</span>
				<span class="token keyword">var</span> gcTaskResponse ShardOperationResponse
				srv <span class="token operator">:=</span> kv<span class="token punctuation">.</span><span class="token function">makeEnd</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
				<span class="token keyword">if</span> srv<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;ShardKV.DeleteShardsData&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>gcTaskRequest<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gcTaskResponse<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> gcTaskResponse<span class="token punctuation">.</span>Err <span class="token operator">==</span> OK <span class="token punctuation">{</span>
					<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} deletes shards %v in remote group successfully when currentConfigNum is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> shardIDs<span class="token punctuation">,</span> configNum<span class="token punctuation">)</span>
					kv<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token function">NewDeleteShardsCommand</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gcTaskRequest<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>CommandResponse<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span>lastConfig<span class="token punctuation">.</span>Groups<span class="token punctuation">[</span>gid<span class="token punctuation">]</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">.</span>Num<span class="token punctuation">,</span> shardIDs<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>ShardKV<span class="token punctuation">)</span> <span class="token function">DeleteShardsData</span><span class="token punctuation">(</span>request <span class="token operator">*</span>ShardOperationRequest<span class="token punctuation">,</span> response <span class="token operator">*</span>ShardOperationResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// only delete shards when role is leader</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>isLeader <span class="token punctuation">{</span>
		response<span class="token punctuation">.</span>Err <span class="token operator">=</span> ErrWrongLeader
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">defer</span> <span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} processes GCTaskRequest %v with response %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span>

	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">.</span>Num <span class="token operator">&gt;</span> request<span class="token punctuation">.</span>ConfigNum <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v}'s encounters duplicated shards deletion %v when currentConfig is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> request<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
		response<span class="token punctuation">.</span>Err <span class="token operator">=</span> OK
		kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	kv<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> commandResponse CommandResponse
	kv<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token function">NewDeleteShardsCommand</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>commandResponse<span class="token punctuation">)</span>

	response<span class="token punctuation">.</span>Err <span class="token operator">=</span> commandResponse<span class="token punctuation">.</span>Err
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>kv <span class="token operator">*</span>ShardKV<span class="token punctuation">)</span> <span class="token function">applyDeleteShards</span><span class="token punctuation">(</span>shardsInfo <span class="token operator">*</span>ShardOperationRequest<span class="token punctuation">)</span> <span class="token operator">*</span>CommandResponse <span class="token punctuation">{</span>
	<span class="token keyword">if</span> shardsInfo<span class="token punctuation">.</span>ConfigNum <span class="token operator">==</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">.</span>Num <span class="token punctuation">{</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v}'s shards status are %v before accepting shards deletion %v when currentConfig is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> kv<span class="token punctuation">.</span><span class="token function">getShardStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shardsInfo<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> shardId <span class="token operator">:=</span> <span class="token keyword">range</span> shardsInfo<span class="token punctuation">.</span>ShardIDs <span class="token punctuation">{</span>
			shard <span class="token operator">:=</span> kv<span class="token punctuation">.</span>stateMachines<span class="token punctuation">[</span>shardId<span class="token punctuation">]</span>
			<span class="token keyword">if</span> shard<span class="token punctuation">.</span>Status <span class="token operator">==</span> GCing <span class="token punctuation">{</span>
				shard<span class="token punctuation">.</span>Status <span class="token operator">=</span> Serving
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> shard<span class="token punctuation">.</span>Status <span class="token operator">==</span> BePulling <span class="token punctuation">{</span>
				kv<span class="token punctuation">.</span>stateMachines<span class="token punctuation">[</span>shardId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">NewShard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v} encounters duplicated shards deletion %v when currentConfig is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> shardsInfo<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v}'s shards status are %v after accepting shards deletion %v when currentConfig is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> kv<span class="token punctuation">.</span><span class="token function">getShardStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shardsInfo<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>CommandResponse<span class="token punctuation">{</span>OK<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">DPrintf</span><span class="token punctuation">(</span><span class="token string">&quot;{Node %v}{Group %v}'s encounters duplicated shards deletion %v when currentConfig is %v&quot;</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>rf<span class="token punctuation">.</span><span class="token function">Me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span>gid<span class="token punctuation">,</span> shardsInfo<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>currentConfig<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>CommandResponse<span class="token punctuation">{</span>OK<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/vuepress-blog/handbook/实验-Lab3A-无快照的 KV Service.html" class="prev">
          实验 3 KV Service
        </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#shardctler" class="sidebar-link reco-side-shardctler" data-v-b57cc07c>ShardCtler</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#客户端" class="sidebar-link reco-side-客户端" data-v-b57cc07c>客户端</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#状态机" class="sidebar-link reco-side-状态机" data-v-b57cc07c>状态机</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#服务端" class="sidebar-link reco-side-服务端" data-v-b57cc07c>服务端</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#shardkv" class="sidebar-link reco-side-shardkv" data-v-b57cc07c>ShardKV</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#整体架构" class="sidebar-link reco-side-整体架构" data-v-b57cc07c>整体架构</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#client" class="sidebar-link reco-side-client" data-v-b57cc07c>client</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/handbook/%E5%AE%9E%E9%AA%8C-Lab4-Shard%20KV%20Service.html#服务端-2" class="sidebar-link reco-side-服务端-2" data-v-b57cc07c>服务端</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/vuepress-blog/assets/js/app.19c88e4d.js" defer></script><script src="/vuepress-blog/assets/js/7.1224f65b.js" defer></script><script src="/vuepress-blog/assets/js/2.3025eebf.js" defer></script><script src="/vuepress-blog/assets/js/1.2cb690fe.js" defer></script><script src="/vuepress-blog/assets/js/46.a6385bcd.js" defer></script>
  </body>
</html>
